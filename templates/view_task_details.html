{% extends "base.html" %}

{% block title %}View Task Updates - Project Tracking System{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-4">
          {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-4">
            {% for category, message in messages %}
                <div class="px-4 py-2 rounded text-white
                            {{ 'bg-green-600' if category == 'success' else 'bg-red-600' }}">
                {{ message }}
                </div>
            {% endfor %}
            </div>
        {% endif %}
        {% endwith %}
    <div class="bg-white shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
            <div class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Task Updates</h1>
                <p class="mt-2 text-gray-600">View and edit updates for task: <span class="prose prose-sm">{{ task[1]|safe }}</span></p>
            </div>
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900">Task Details</h3>
                <div class="mt-2 text-sm text-gray-600">
                    <p><strong>Project:</strong> {{ project[1] }}</p>
                    <div class="mt-2">
                        <strong>Description:</strong>
                        <!-- Task description content rendered as HTML -->
                        <div class="mt-1 prose prose-sm max-w-none text-gray-700" id="taskDescription"></div>
                    </div>
                    <p class="mt-2"><strong>Priority:</strong> 
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if task[4] == 'high' %}bg-red-100 text-red-800
                            {% elif task[4] == 'medium' %}bg-yellow-100 text-yellow-800
                            {% else %}bg-green-100 text-green-800{% endif %}">
                            {{ task[4].title() }}
                        </span>
                    </p>
                    <p class="mt-2"><strong>Status:</strong> 
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                            {% if task[5] == 'completed' %}bg-green-100 text-green-800
                            {% elif task[5] == 'in_progress' %}bg-blue-100 text-blue-800
                            {% else %}bg-gray-100 text-gray-800{% endif %}">
                            {{ task[5].replace('_', ' ').title() }}
                        </span>
                    </p>
                    <p class="mt-2"><strong>Dates:</strong> {{ task[6] }} - {{ task[7] if task[7] else 'Ongoing' }}</p>
                </div>
            </div>

            <!-- Task Update Modal -->
            <div id="taskUpdateModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 9999;">
                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; border-radius: 8px; padding: 0; min-width: 400px; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
                    <!-- Header -->
                    <div style="padding: 20px 24px 0 24px; border-bottom: 1px solid #e5e7eb;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 18px; font-weight: 600; color: #111827;">Add Task Update</h3>
                            <button type="button" onclick="closeTaskUpdateModal()" style="background: none; border: none; color: #9ca3af; cursor: pointer; font-size: 20px; padding: 4px;">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Body -->
                    <div style="padding: 24px;">
                        <form method="POST" id="taskUpdateForm" action="{{ url_for('add_task_detail') }}">
                            <input type="hidden" name="task_id" id="modalTaskId">
                            <input type="hidden" name="detail_id" id="modalDetailId">
                            <input type="hidden" name="project_id" id="modalProjectId" value="{{ project[0] }}">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Task:</label>
                                <div id="modalTaskName" style="font-size: 14px; color: #6b7280; background-color: #f9fafb; padding: 8px; border-radius: 4px; border: 1px solid #e5e7eb;"></div>
                            </div>
                            
                            <div style="margin-bottom: 16px;">
                                <label for="desc" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Work Description</label>
                                <textarea name="desc" id="desc" rows="4" required
                                        style="width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px; resize: vertical;"
                                        placeholder="Describe the work you completed today..."></textarea>
                            </div>
                            
                            <div style="margin-bottom: 24px;">
                                <label for="status" style="display: block; font-size: 14px; font-weight: 500; color: #374151; margin-bottom: 8px;">Status</label>
                                <select name="status" id="status" required
                                        style="width: 100%; border: 1px solid #d1d5db; border-radius: 6px; padding: 8px 12px; font-size: 14px;">
                                    <option value="incomplete">Incomplete</option>
                                    <option value="complete">Complete</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; justify-content: flex-end; gap: 12px;">
                                <button type="button" onclick="closeTaskUpdateModal()"
                                        style="background: white; color: #374151; border: 1px solid #d1d5db; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                    Cancel
                                </button>
                                <button type="submit"
                                        style="background: #2563eb; color: white; border: none; padding: 8px 16px; border-radius: 6px; font-size: 14px; cursor: pointer;">
                                    <i class="fas fa-save" style="margin-right: 8px;"></i>Save Update
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <h3 class="text-lg font-medium text-gray-900 mb-4">Your Updates</h3>
            {% if details %}
            <div class="space-y-4">
                {% for detail in details %}
                <div class="bg-gray-50 rounded-lg p-4">
                    <div class="flex justify-between items-start">
                        <div class="flex-grow">
                            <div class="prose prose-sm max-w-none text-gray-600">{{ detail[1]|safe }}</div>
                            <div class="mt-2 flex items-center space-x-4 text-sm text-gray-500">
                                <span>{{ detail[2] }}</span>
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if detail[3] == 'completed' %}bg-green-100 text-green-800
                                    {% elif detail[3] == 'in_progress' %}bg-blue-100 text-blue-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ detail[3].replace('_', ' ').title() }}
                                </span>
                            </div>
                        </div>
                        <button onclick="editTaskUpdate({{ detail[0] }})"
                                class="ml-4 text-sm font-medium text-primary hover:text-blue-700">
                            Edit
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-gray-500 italic">No updates available.</p>
            {% endif %}

            <div class="mt-6 flex justify-end space-x-3 border-t border-gray-200 pt-6">
                <button 
                    onclick="openTaskUpdateForm({{ task[0] }}, &quot;{{ task[1]|e }}&quot;)" 
                    class="flex-1 sm:flex-none bg-primary text-white px-3 sm:px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200 text-sm sm:text-base">
                    <i class="fas fa-plus mr-1"></i>Add Update
                </button>
                <a href="{{ url_for('employee_dashboard') }}"
                   class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</div>

<script>
    // Safely render the task description HTML
    document.getElementById('taskDescription').innerHTML = `{{ task[1]|safe }}`;
</script>
<script>
function openTaskUpdateForm(taskId, taskName) {
    const modal = document.getElementById('taskUpdateModal');
    document.getElementById('modalTaskId').value = taskId;
    document.getElementById('modalTaskName').innerHTML = taskName;
    document.getElementById('desc').value = '';
    document.getElementById('status').value = 'incomplete';
    document.getElementById('modalDetailId').value = '';
    document.getElementById('taskUpdateForm').action = '{{ url_for("add_task_detail") }}';
    modal.style.display = 'block';
    setTimeout(() => { document.getElementById('desc').focus(); }, 100);
}

    function closeTaskUpdateModal() {
        
        // Get modal element
        const modal = document.getElementById('taskUpdateModal');
        
        // Hide the modal
        modal.style.display = 'none';
        
        // Clear the form
        document.getElementById('desc').value = '';
        document.getElementById('status').value = 'incomplete';
        document.getElementById('modalTaskId').value = '';
        document.getElementById('modalTaskName').innerHTML = '';
        
    }

    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
        // Close modal when clicking on backdrop
        document.getElementById('taskUpdateModal').addEventListener('click', function(e) {
            // Only close if clicking the backdrop (not the modal content)
            if (e.target === this) {
                closeTaskUpdateModal();
            }
        });

        // Handle escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('taskUpdateModal');
                if (modal.style.display === 'block') {
                    closeTaskUpdateModal();
                }
            }
        });
    });

    function editTaskUpdate(detailId) {
        fetch(`/api/task_detail/${detailId}`)
            .then(response => response.json())
            .then(data => {
                const modal = document.getElementById('taskUpdateModal');
                document.getElementById('modalTaskId').value = data.task_id;
                document.getElementById('modalDetailId').value = detailId;
                document.getElementById('modalTaskName').innerHTML = data.task_name;
                document.getElementById('desc').value = data.desc;
                document.getElementById('status').value = data.status;
                document.getElementById('taskUpdateForm').action = `/employee/edit_task_detail/${detailId}`;
                modal.style.display = 'block';
                setTimeout(() => { document.getElementById('desc').focus(); }, 100);
            })
            .catch(error => alert("Failed to load task detail."));
    }
</script>
{% endblock %}