<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Project Tracking System{% endblock %}</title>

    <!-- Tailwind + icons -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">

    <!-- Quill (optional, keep if you use it) -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

    <link rel="shortcut icon" href="static/images/favicon/favicon.ico" type="image/x-icon">

    <style>
        html {
            scroll-behavior: smooth
        }

        body {
            font-family: "Plus Jakarta Sans", sans-serif
        }

        /* Utility for backdrop when sidebar is open on mobile */
        .backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, .4);
            z-index: 30;
        }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#64748B',
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-gray-100 antialiased">

    {% if session.user_id %}
    {% set SIDEBAR_W = '64' %}
    {% set employee_active = request.endpoint in ['add_employee','view_employees'] %}
    {% set project_active = request.endpoint in ['add_project','view_projects'] %}
    {% set leave_active = request.endpoint in ['admin_leave_types', 'admin_leave_requests', 'admin_leave_summary'] %}
    {% set expense_active = request.endpoint in ['admin_expense_types','expense', 'existing_expenses'] %}
    {% set task_active = request.endpoint in ['add_task','view_tasks'] %}
    {% set asset_active = request.endpoint in ['add_asset','view_assets','manage_allocation','asset_history'] %}
    {% set careers_active = request.endpoint in ['add_job', 'view_jobs', 'employee_careers'] %}
    {% set wiki_active = request.endpoint in ['admin_wiki_categories','add_wiki','view_wikis','edit_wiki'] %}
    {% set celebrations_active = request.endpoint in ['admin_employee_celebrations', 'employee_celebrations'] %}
    {% set admin_dashboard_active = request.endpoint == 'admin_dashboard' %}
    {% set employee_dashboard_active = request.endpoint == 'employee_dashboard' %}
    {% set admin_wiki_views_active = request.endpoint == 'admin_wiki_views' %}
    {% set employee_wiki_list_active = request.endpoint == 'employee_wiki_list' %}
    {% set add_wiki_active = request.endpoint == 'add_wiki' %}
    {% set view_wikis_active = request.endpoint == 'view_wikis' %}
    {% set is_policies_active = request.endpoint in ['list_policies', 'add_policy'] %}
    {% set employee_assets_active = request.endpoint in ['employee_assets'] %}
    {% set employee_policies_active = request.endpoint == 'employee_policies' %}

    <aside id="sidebar" class="hidden md:block fixed top-0 left-0 h-screen w-{{ SIDEBAR_W }} bg-white shadow-lg z-40">
        <div class="flex flex-col h-full">
            <!-- logo -->
            <div class="flex items-center justify-center h-20 border-b border-r">
                <a href="/">
                    <img src="{{ url_for('static', filename='images/ATS.png') }}" alt="Logo"
                        class="h-[4.5rem] w-auto object-contain">
                </a>
            </div>

            <!-- nav -->
            <nav class="flex-1 overflow-y-auto py-4 space-y-2 text-sm border-r">
                {% macro navlink(label, icon, endpoint) -%}
                {% set active = request.endpoint == endpoint %}
                <a href="{{ url_for(endpoint) }}" class="flex items-center px-5 py-2 rounded-md transition
                              {{ 'bg-blue-100 text-green-600 font-medium' if active
                                 else 'text-gray-700 hover:bg-gray-100' }}">
                    <i class="{{ icon }} w-4 mr-3 text-base"></i> {{ label }}
                </a>
                {%- endmacro %}

                {{ navlink('Dashboard','fas fa-tachometer-alt',
                session.emp_type=='admin' and 'admin_dashboard'
                or 'employee_dashboard') }}

                {% if session.emp_type == 'admin' %}

                <!-- Employee -->
                <details class="group" {{ 'open' if employee_active else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if employee_active
                                           else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-users w-4 mr-3"></i> Employee
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Add Employee','fas fa-user-plus','add_employee') }}
                        {{ navlink('View Employees','fas fa-address-book','view_employees') }}
                    </div>
                </details>

                <!-- Leave -->
                <details class="group" {{ 'open' if leave_active else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if leave_active
                                           else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-plane-departure w-4 mr-3"></i> Leave Management
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Leave Types','fas fa-tags','admin_leave_types') }}
                        {{ navlink('Requests','fas fa-envelope-open','admin_leave_requests') }}
                        {{ navlink('Summary / Filter','fas fa-filter','admin_leave_summary') }}
                    </div>
                </details>

                <!-- Expense -->
                <details class="group" {{ 'open' if expense_active else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if expense_active
                                           else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-money-bill-wave w-4 mr-3"></i> Manage Expense
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Expense Types','fas fa-tags','admin_expense_types') }}
                        {{ navlink('Add Expenses','fas fa-clipboard-list','expense') }}
                        {{ navlink('Expenses List','fas fa-list','existing_expenses') }}
                    </div>
                </details>

                <!-- Task -->
                <details class="group" {{ 'open' if task_active else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if task_active
                                           else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-tasks w-4 mr-3"></i> Task
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Add Task','fas fa-plus','add_task') }}
                        {{ navlink('View Tasks','fas fa-list','view_tasks') }}
                    </div>
                </details>

                <!-- Policies -->
                <details class="group" {{ 'open' if is_policies_active else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                        {{ 'bg-blue-100 text-green-600 font-medium' if is_policies_active
                           else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-solid fa-landmark-dome w-4 mr-3"></i> Policies
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('View Policies','fas fa-clipboard-list','list_policies') }}
                        {{ navlink('Add Policies','fas fa-address-book','add_policy') }}
                    </div>
                </details>

                <!-- Assets -->
                <details class="group" {{ 'open' if request.endpoint in ['add_asset','view_assets', 'manage_allocation'
                    , 'asset_history' ] else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if request.endpoint in ['add_asset','view_assets', 'manage_allocation', 'asset_history']
                                        else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-box-open w-4 mr-3"></i> Assets
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Add Asset','fas fa-plus','add_asset') }}
                        {{ navlink('View Assets','fas fa-list','view_assets') }}
                        {{ navlink('Manage Allocations','fas fa-tasks','manage_allocation') }}
                        {{ navlink('History','fas fa-history','asset_history') }}
                    </div>
                </details>

                <!-- Careers -->
                <details class="group" {{ 'open' if request.endpoint in ['add_job', 'view_jobs' , 'employee_careers' ]
                    else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if request.endpoint in ['add_job', 'view_jobs', 'employee_careers']
                                        else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-briefcase w-4 mr-3"></i> Careers
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Add Job','fas fa-plus','add_job') }}
                        {{ navlink('View Jobs','fas fa-list','view_jobs') }}
                    </div>
                </details>

                <!-- Wiki -->
                <details class="group" {{ 'open' if request.endpoint in
                    ['admin_wiki_categories','add_wiki','view_wikis','edit_wiki', 'admin_wiki_views' ] else '' }}>
                    <summary
                        class="flex items-center px-5 py-2 cursor-pointer rounded-md
                                        {{ 'bg-blue-100 text-green-600 font-medium' if request.endpoint in ['admin_wiki_categories','add_wiki','view_wikis','edit_wiki', 'admin_wiki_views'] else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-book w-4 mr-3"></i> Wiki
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Categories','fas fa-tags','admin_wiki_categories') }}
                        {{ navlink('Add Wiki','fas fa-plus','add_wiki') }}
                        {{ navlink('View Wikis','fas fa-list','view_wikis') }}
                        {{ navlink('Wiki Views','fas fa-eye','admin_wiki_views') }}
                    </div>
                </details>

                <!-- Employee Celebrations -->
                <details class="group" {{ 'open' if celebrations_active else '' }}>
                    <summary class="flex items-center px-5 py-2 cursor-pointer rounded-md
                        {{ 'bg-blue-100 text-green-600 font-medium' if celebrations_active
                           else 'text-gray-700 hover:bg-gray-100' }}">
                        <i class="fas fa-birthday-cake w-4 mr-3"></i> Celebrations
                        <i class="fas fa-chevron-down ml-auto transform transition group-open:rotate-180"></i>
                    </summary>
                    <div class="pl-9 mt-1 space-y-1">
                        {{ navlink('Anniversaries & Birthdays','fas fa-gift','admin_employee_celebrations') }}
                    </div>
                </details>

                {% else %}
                {% set disabled = 'pointer-events-none opacity-50' if emg_missing else '' %}
                <div>
                    {{ navlink('Manage Expense','fas fa-money-bill-wave','expense') }}
                    {{ navlink('My Expense','fas fa-list','existing_expenses') }}
                    {{ navlink('Leave Request','fas fa-plane-departure','employee_leave') }}
                    {{ navlink('My Leave Request','fas fa-clock','employee_leave_requests') }}
                    {{ navlink('Company Policies','fas fa-file-alt','employee_policies') }}
                    {{ navlink('Careers','fas fa-briefcase','employee_careers') }}
                    {{ navlink('My Assets','fas fa-box','employee_assets') }}
                    {{ navlink('Wiki','fas fa-book','employee_wiki_list') }}
                    {{ navlink('Celebrations','fas fa-birthday-cake','employee_celebrations') }}
                </div>
                {% endif %}
            </nav>
        </div>
    </aside>

    <nav class="bg-white sticky top-0 z-30
                flex items-center justify-center h-[5rem] px-4 sm:px-8">
        <!-- hamburger for mobile -->
        <button id="mobile-menu-button" class="md:hidden inline-flex items-center justify-center p-2 rounded
                       text-gray-700 hover:bg-gray-100 focus:outline-none">
            <span class="sr-only">Open main menu</span>
            <i class="fas fa-bars text-lg"></i>
        </button>

        <div class="ml-auto flex items-center justify-center space-x-4">
            {% if session.emp_type == 'emp' %}
            <a href="{{ url_for('employee_profile_view') }}"
                class="text-sm px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">
                <i class="fas fa-user-circle mr-1"></i>My Profile
            </a>
            {% endif %}
            <span class="hidden sm:block text-sm text-gray-700">
                {{ session.first_name }} {{ session.last_name }} ({{ session.emp_type.title() }})
            </span>
            <button id="logoutButton" class="flex items-center gap-2 px-3 py-2 rounded-md bg-red-600 hover:bg-red-700
                           text-white text-sm font-medium focus:outline-none">
                <span class="hidden sm:inline">Logout</span>
                <i class="fas fa-sign-out-alt text-sm"></i>
            </button>
        </div>
    </nav>
    {% endif %}

    <div class="{% if session.user_id %}md:ml-{{ SIDEBAR_W }}{% endif %}">
        <main class="py-8 px-4 sm:px-6 lg:px-8 max-w-7xl mx-auto">
            {% block content %}{% endblock %}
        </main>
    </div>

    <div id="logoutModal" class="fixed inset-0 z-50 hidden flex items-center justify-center">
        <div class="absolute inset-0 bg-black/50"></div>
        <div class="relative bg-white rounded-lg shadow-lg w-full max-w-sm p-6">
            <h2 class="text-lg font-semibold mb-4">Ready to leave?</h2>
            <p class="text-sm text-gray-600 mb-6">
                Select "Logout" below if you are ready to end your current session.
            </p>
            <div class="flex justify-end space-x-2">
                <button id="cancelLogout" class="px-4 py-2 rounded-md bg-gray-200 hover:bg-gray-300 text-gray-700">
                    Cancel
                </button>
                <form action="{{ url_for('logout') }}" method="post">
                    <button type="submit" class="px-4 py-2 rounded-md bg-red-600 hover:bg-red-700 text-white">
                        Logout
                    </button>
                </form>
            </div>
        </div>
    </div>

    <script>
        const sidebar = document.getElementById('sidebar');
        const burger = document.getElementById('mobile-menu-button');
        const sbBackdrop = document.createElement('div');
        sbBackdrop.className = 'backdrop hidden md:hidden';
        document.body.appendChild(sbBackdrop);

        function toggleSidebar() {
            sidebar.classList.toggle('hidden');
            sbBackdrop.classList.toggle('hidden');
        }
        burger?.addEventListener('click', toggleSidebar);
        sbBackdrop.addEventListener('click', toggleSidebar);

        const logoutBtn = document.getElementById('logoutButton');
        const logoutModal = document.getElementById('logoutModal');
        const cancelBtn = document.getElementById('cancelLogout');

        logoutBtn?.addEventListener('click', () => logoutModal.classList.remove('hidden'));
        cancelBtn?.addEventListener('click', () => logoutModal.classList.add('hidden'));

        logoutModal.addEventListener('click', e => {
            if (e.target === logoutModal) logoutModal.classList.add('hidden');
        });
    </script>
</body>

</html>
