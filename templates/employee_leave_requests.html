{% extends "base.html" %} 
{% block title %}My Leave Requests{% endblock %} 
{% block content %}

<div class="bg-white shadow rounded-lg">
  <div class="">
    {% with messages = get_flashed_messages(with_categories=true) %} 
    {% if messages %}
    <div class="mb-4">
      {% for category, message in messages %}
      <div class="px-4 py-2 rounded text-white
                    {{ 'bg-green-600' if category == 'success' else 'bg-red-600' }}">
        {{ message }}
      </div>
      {% endfor %}
    </div>
    {% endif %} 
    {% endwith %}
  </div>
  
  <div class="mb-8">
    <h1 class="text-2xl font-bold text-gray-900 text-left pt-4 ml-8">
      My Leave Request
    </h1>
  </div>
  
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white rounded-md shadow text-sm">
      <thead class="bg-gray-50 text-left uppercase text-xs font-medium text-gray-500">
        <tr>
          <th class="px-4 py-3">Type</th>
          <th class="px-4 py-3">Dates</th>
          <th class="px-4 py-3">Days</th>
          <th class="px-4 py-3">Status</th>
          <th class="px-4 py-3">Manager Comments</th>
          
          {% if my_requests and my_requests[0] and my_requests[0][6] == 'pending' %}
          <th class="px-4 py-3">Delete</th>
          {% endif %}
        </tr>
      </thead>
      
      <tbody class="divide-y">
        {% for r in my_requests %} 
        {% set days = (r[4]|todate - r[3]|todate).days + 1 %}
        <tr>
          <td class="px-4 py-3">{{ r[1] }}</td>
          <td class="px-4 py-3">{{ r[3] }} â†’ {{ r[4] }}</td>
          <td class="px-4 py-3">{{ days }}</td>
          <td class="px-4 py-3" style="text-transform: capitalize">
            {{ r[6] }}
          </td>
          <td class="px-1 py-3">{{ r[7] or 'Comment will be shown here' }}</td>
          <td class="px-4 py-3">
            {% if r[6] == 'pending' %}
            <button type="button" 
                    onclick="showDeleteModal('{{ r[0] }}')" 
                    class="btn text-red-500 btn-danger btn-sm">
              Delete
            </button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="px-4 py-6 text-center text-gray-500">
            No leave requests found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center">
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm mx-4">
    <h3 class="text-lg font-medium text-gray-900 mb-4">
      Confirm Delete
    </h3>
    <p class="text-gray-500 mb-6">
      Do you want to delete this request?
    </p>
    <div class="flex justify-end space-x-3">
      <button type="button" 
              onclick="hideDeleteModal()" 
              class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
        No
      </button>
      <button type="button" 
              onclick="confirmDelete()" 
              class="px-4 py-2 text-sm font-medium text-white bg-red-600 rounded-md hover:bg-red-700">
        Yes
      </button>
    </div>
  </div>
</div>

<!-- Hidden form for deletion -->
<form id="deleteForm" method="POST" style="display: none;">
  <!-- Form action will be set dynamically -->
</form>

<script>
let currentRequestId = null;
const deleteUrlBase = "{{ url_for('delete_leave_request', request_id=1) }}".replace('1', '');

function showDeleteModal(requestId) {
  currentRequestId = requestId;
  document.getElementById('deleteModal').classList.remove('hidden');
}

function hideDeleteModal() {
  document.getElementById('deleteModal').classList.add('hidden');
  currentRequestId = null;
}

function confirmDelete() {
  if (currentRequestId) {
    const form = document.getElementById('deleteForm');
    form.action = deleteUrlBase + currentRequestId;
    form.submit();
  }
}

// Close modal when clicking outside
document.getElementById('deleteModal').addEventListener('click', function(e) {
  if (e.target === this) {
    hideDeleteModal();
  }
});
</script>

{% endblock %}
