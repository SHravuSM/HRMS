{% extends "base.html" %}

{% block title %}View Projects - Project Tracking System{% endblock %}

{% block content %}
<style>
    .dropdown-menu {
        transform-origin: top right;
        transition: opacity 0.2s ease-in-out;
        pointer-events: auto;
    }
</style>

<div class="max-w-7xl mx-auto lg:px-2 max-md:w-[23rem]">
    <div class="bg-white shadow rounded-lg">
        {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-4">
        {% for category, message in messages %}
          <div class="px-4 py-2 rounded text-white
                      {{ 'bg-green-600' if category == 'success' else 'bg-red-600' }}">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 text-center pt-4">Projects</h1>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for project in projects %}
                        <tr>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ project[1] }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if project[2] == 'high' %}bg-red-100 text-red-800
                                    {% elif project[2] == 'medium' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ project[2].title() }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if project[4] == 'active' %}bg-green-100 text-green-800
                                    {% elif project[4] == 'completed' %}bg-blue-100 text-blue-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ project[4].replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div>Start: {{ project[5] }}</div>
                                <div>End: {{ project[6] if project[6] else 'Not set' }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="relative inline-block text-left">
                                    <button onclick="toggleDropdown(this)"
                                        class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                        Actions
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd"
                                                d="M5.23 7.21a.75.75 0 011.06.02L10 11.586l3.71-4.356a.75.75 0 011.14.976l-4.25 5a.75.75 0 01-1.14 0l-4.25-5a.75.75 0 01.02-1.06z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <div
                                        class="hidden fixed origin-top-right z-50 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 dropdown-menu">
                                        <a href="{{ url_for('view_project', project_id=project[0]) }}"
                                        class="block px-4 py-2 text-sm text-blue-700 hover:bg-blue-100">
                                            <i class="fas fa-eye mr-1 text-blue-500"></i> View
                                        </a>
                                        <a href="{{ url_for('edit_project', project_id=project[0]) }}"
                                        class="block px-4 py-2 text-sm text-yellow-700 hover:bg-yellow-100">
                                            <i class="fas fa-edit mr-1 text-yellow-600"></i> Edit
                                        </a>
                                        <button
                                            onclick="confirmDelete('project', {{ project[0] }}, '{{ url_for('delete_project', project_id=project[0]) }}')"
                                            class="w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-100">
                                            <i class="fas fa-trash mr-1"></i> Delete
                                        </button>
                                    </div>
                                </div>

                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    function confirmDelete(type, id, url) {
        if (confirm(`Are you sure you want to delete this ${type}?`)) {
            window.location.href = url;
        }
    }
</script>
<script>
    function toggleDropdown(button) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));

        const menu = button.nextElementSibling;

        const btnRect = button.getBoundingClientRect();
        const offsetLeft = 100;
        menu.style.top = `${window.scrollY + btnRect.bottom}px`;
        menu.style.left = `${window.scrollX + btnRect.right - menu.offsetWidth - offsetLeft}px`;

        if (parseInt(menu.style.left) < window.scrollX) {
            menu.style.left = `${window.scrollX}px`;
        }

        const spaceBelow = window.innerHeight - btnRect.bottom;
        if (spaceBelow < menu.offsetHeight && btnRect.top > menu.offsetHeight) {
            menu.style.top = `${window.scrollY + btnRect.top - menu.offsetHeight}px`;
        }

        menu.classList.remove('hidden');
    }

    document.addEventListener('click', function (event) {
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        dropdowns.forEach(menu => {
            if (!menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    });
</script>

{% endblock %}