{% extends "base.html" %}

{% block title %}View Tasks - Project Tracking System{% endblock %}

{% block content %}
<style>
    .dropdown-menu {
        transform-origin: top right;
        transition: opacity 0.2s ease-in-out;
        pointer-events: auto;
    }
</style>

<div class="max-w-6xl mx-auto  lg:px-2 max-md:w-[23rem]">
      {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    <div class="mb-4">
      {% for category, message in messages %}
        <div class="px-4 py-2 rounded text-white
                    {{ 'bg-green-600' if category == 'success' else 'bg-red-600' }}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}
{% endwith %}
    <div class="bg-white shadow rounded-lg">
        <div class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900 pt-4 text-center">Tasks</h1>
        </div>
        <div class="px-4 py-5 sm:p-6">
            <div class="flex justify-between items-center mb-6 flex-col md:flex-row space-y-4 md:space-y-0">
                <h3 class="text-lg leading-6 font-medium text-gray-900">
                    <i class="fas fa-list-alt mr-2"></i>All Tasks
                </h3>
                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full md:w-auto">
                    <select id="projectFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full sm:w-auto">
                        <option value="">All Projects</option>
                        {% for project in projects %}
                        <option value="{{ project[1] }}">{{ project[1] }}</option>
                        {% endfor %}
                    </select>
                    <select id="statusFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full sm:w-auto">
                        <option value="">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="in_progress">In Progress</option>
                        <option value="completed">Completed</option>
                    </select>
                    <select id="employeeFilter" class="border border-gray-300 rounded-md px-3 py-2 text-sm w-full sm:w-auto">
                        <option value="">All Employees</option>
                        {% for employee in employees %}
                        {% if employee[9] == 'emp' %}
                        <option value="{{ employee[1] }} {{ employee[2] }}">{{ employee[1] }} {{ employee[2] }}</option>
                        {% endif %}
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200" id="tasksTable">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Task</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Project</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Employee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Dates</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for task in tasks %}
                        <tr class="task-row" data-project="{{ task[6] }}" data-status="{{ task[3] }}" data-employee="{{ task[7] }} {{ task[8] }}">
                            <td class="px-4 py-4 whitespace-nowrap">
                                <div class="text-sm font-medium text-gray-900">{{ task[1][:50]|safe }}{% if task[1]|length > 50 %}...{% endif %}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ task[6] }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="text-sm text-gray-900">{{ task[7] }} {{ task[8] }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if task[2] == 'high' %}bg-red-100 text-red-800
                                    {% elif task[2] == 'medium' %}bg-yellow-100 text-yellow-800
                                    {% else %}bg-green-100 text-green-800{% endif %}">
                                    {{ task[2].title() }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium
                                    {% if task[3] == 'completed' %}bg-green-100 text-green-800
                                    {% elif task[3] == 'in_progress' %}bg-blue-100 text-blue-800
                                    {% else %}bg-gray-100 text-gray-800{% endif %}">
                                    {{ task[3].replace('_', ' ').title() }}
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                <div>Start: {{ task[4] if task[4] else 'Not set' }}</div>
                                <div>End: {{ task[5] if task[5] else 'Not set' }}</div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                <div class="relative inline-block text-left">
                                    <button onclick="toggleDropdown(this)"
                                        class="inline-flex justify-center w-full rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-gray-700 hover:bg-gray-50">
                                        Actions
                                        <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg"
                                            viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                            <path fill-rule="evenodd"
                                                d="M5.23 7.21a.75.75 0 011.06.02L10 11.586l3.71-4.356a.75.75 0 011.14.976l-4.25 5a.75.75 0 01-1.14 0l-4.25-5a.75.75 0 01.02-1.06z"
                                                clip-rule="evenodd" />
                                        </svg>
                                    </button>
                                    <div
                                        class="hidden fixed origin-top-right z-50 w-36 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 dropdown-menu">
                                        <a href="{{ url_for('show_task_details', task_id=task[0]) }}"
                                        class="block px-4 py-2 text-sm text-blue-700 hover:bg-blue-100">
                                            <i class="fas fa-eye mr-1 text-blue-500"></i> View
                                        </a>
                                        <a href="{{ url_for('edit_task', task_id=task[0]) }}"
                                        class="block px-4 py-2 text-sm text-yellow-700 hover:bg-yellow-100">
                                            <i class="fas fa-edit mr-1 text-yellow-600"></i> Edit
                                        </a>
                                        <button
                                            onclick="confirmDelete('task', {{ task[0] }}, '{{ url_for('delete_task', task_id=task[0]) }}')"
                                            class="w-full text-left px-4 py-2 text-sm text-red-700 hover:bg-red-100">
                                            <i class="fas fa-trash mr-1"></i> Delete
                                        </button>
                                    </div>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Task Updates Modal -->
<div id="taskModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-xl max-w-lg w-full max-h-[80vh] overflow-y-auto">
        <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
            <h3 class="text-lg font-semibold text-gray-900">Task Updates</h3>
            <button onclick="closeModal()" class="text-gray-500 hover:text-gray-700">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="px-6 py-6">
            <div id="modalTaskDetails" class="space-y-4"></div>
        </div>
        <div class="px-6 py-4 border-t border-gray-200 flex justify-end">
            <button onclick="closeModal()" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 transition duration-200">
                Close
            </button>
        </div>
    </div>
</div>

<script>
    // Filter functionality
    function filterTasks() {
        const projectFilter = document.getElementById('projectFilter').value.toLowerCase();
        const statusFilter = document.getElementById('statusFilter').value.toLowerCase();
        const employeeFilter = document.getElementById('employeeFilter').value.toLowerCase();
        const rows = document.querySelectorAll('.task-row');

        rows.forEach(row => {
            const project = row.dataset.project.toLowerCase();
            const status = row.dataset.status.toLowerCase();
            const employee = row.dataset.employee.toLowerCase();

            const projectMatch = !projectFilter || project === projectFilter;
            const statusMatch = !statusFilter || status === statusFilter;
            const employeeMatch = !employeeFilter || employee.includes(employeeFilter);

            if (projectMatch && statusMatch && employeeMatch) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });
    }

    // Delete confirmation
    function confirmDelete(type, id, url) {
        if (confirm(`Are you sure you want to delete this ${type}?`)) {
            window.location.href = url;
        }
    }

    // Modal functions
    function showTaskDetails(taskId) {
        // Fetch task details
        fetch(`/api/task_details/${taskId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                const detailsContainer = document.getElementById('modalTaskDetails');
                detailsContainer.innerHTML = '';
                if (data.error) {
                    detailsContainer.textContent = `Error: ${data.message || data.error}`;
                    detailsContainer.className = 'text-red-600 text-sm';
                } else if (data.length === 0) {
                    detailsContainer.textContent = 'No updates available.';
                    detailsContainer.className = 'text-gray-500 text-sm italic';
                } else {
                    data.forEach(detail => {
                        const detailElement = document.createElement('div');
                        detailElement.className = 'relative pl-8 pb-4';
                        detailElement.innerHTML = `
                            <div class="absolute left-2 top-0 h-full w-1 bg-blue-200"></div>
                            <div class="absolute left-0 top-1 w-4 h-4 bg-blue-600 rounded-full"></div>
                            <div class="prose prose-sm max-w-none">${detail.desc}</div>
                            <p class="text-xs text-gray-500 mt-1">
                                <strong>Status:</strong> ${detail.status.charAt(0).toUpperCase() + detail.status.slice(1)}
                            </p>
                            <p class="text-xs text-gray-500">
                                <strong>Date:</strong> ${detail.inserted_date || 'Not set'}
                            </p>
                        `;
                        detailsContainer.appendChild(detailElement);
                    });
                    detailsContainer.className = 'space-y-4';
                }
            })
            .catch(error => {
                const detailsContainer = document.getElementById('modalTaskDetails');
                detailsContainer.textContent = `Error loading task updates: ${error.message}`;
                detailsContainer.className = 'text-red-600 text-sm';
                console.error('Error fetching task details:', error);
            });

        // Show modal
        document.getElementById('taskModal').classList.remove('hidden');
    }

    function closeModal() {
        document.getElementById('taskModal').classList.add('hidden');
        document.getElementById('modalTaskDetails').innerHTML = '';
    }

    // Add event listeners to filters
    document.getElementById('projectFilter').addEventListener('change', filterTasks);
    document.getElementById('statusFilter').addEventListener('change', filterTasks);
    document.getElementById('employeeFilter').addEventListener('change', filterTasks);

    // Close modal when clicking outside
    document.getElementById('taskModal').addEventListener('click', function(event) {
        if (event.target === this) {
            closeModal();
        }
    });
</script>
<script>
    function toggleDropdown(button) {
        document.querySelectorAll('.dropdown-menu').forEach(menu => menu.classList.add('hidden'));

        const menu = button.nextElementSibling;

        const btnRect = button.getBoundingClientRect();
        const offsetLeft = 100;
        menu.style.top = `${window.scrollY + btnRect.bottom}px`;
        menu.style.left = `${window.scrollX + btnRect.right - menu.offsetWidth - offsetLeft}px`;

        if (parseInt(menu.style.left) < window.scrollX) {
            menu.style.left = `${window.scrollX}px`;
        }

        const spaceBelow = window.innerHeight - btnRect.bottom;
        if (spaceBelow < menu.offsetHeight && btnRect.top > menu.offsetHeight) {
            menu.style.top = `${window.scrollY + btnRect.top - menu.offsetHeight}px`;
        }

        menu.classList.remove('hidden');
    }

    document.addEventListener('click', function (event) {
        const dropdowns = document.querySelectorAll('.dropdown-menu');
        dropdowns.forEach(menu => {
            if (!menu.contains(event.target) && !menu.previousElementSibling.contains(event.target)) {
                menu.classList.add('hidden');
            }
        });
    });
</script>

{% endblock %}